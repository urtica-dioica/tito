5946cfeb871d41bd27afd502027b5e8e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const attendanceService_1 = require("../../../src/services/attendance/attendanceService");
const testHelpers_1 = require("../../utils/testHelpers");
const setup_1 = require("../../setup");
describe('AttendanceService', () => {
    let testHelpers;
    let createdUserIds = [];
    let createdEmployeeIds = [];
    let createdDepartmentIds = [];
    beforeAll(async () => {
        const { testDbPool } = await (0, setup_1.initializeTestConnections)();
        testHelpers = new testHelpers_1.TestHelpers(testDbPool);
    });
    afterEach(async () => {
        // Clean up created data after each test
        for (const employeeId of createdEmployeeIds) {
            try {
                await testHelpers.deleteEmployee(employeeId);
            }
            catch (error) {
                // Ignore cleanup errors
            }
        }
        for (const userId of createdUserIds) {
            try {
                await testHelpers.deleteUser(userId);
            }
            catch (error) {
                // Ignore cleanup errors
            }
        }
        for (const departmentId of createdDepartmentIds) {
            try {
                await testHelpers.deleteDepartment(departmentId);
            }
            catch (error) {
                // Ignore cleanup errors
            }
        }
        createdUserIds = [];
        createdEmployeeIds = [];
        createdDepartmentIds = [];
    });
    describe('clockIn', () => {
        it('should successfully clock in employee', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            const clockInData = {
                employeeId: employee.id,
                qrCodeHash: 'test-qr-hash',
                timestamp: new Date('2025-01-15T08:00:00Z'),
                selfieImagePath: '/uploads/selfies/test-selfie.jpg'
            };
            // Act
            const result = await attendanceService_1.attendanceService.clockIn(clockInData);
            // Assert
            expect(result).toHaveProperty('employeeId');
            expect(result).toHaveProperty('date');
            expect(result).toHaveProperty('sessions');
            expect(result.employeeId).toBe(employee.id);
        });
        it('should handle clock in for non-existent employee', async () => {
            // Arrange
            const clockInData = {
                employeeId: 'non-existent-id',
                qrCodeHash: 'test-qr-hash',
                timestamp: new Date('2025-01-15T08:00:00Z'),
                selfieImagePath: '/uploads/selfies/test-selfie.jpg'
            };
            // Act & Assert
            await expect(attendanceService_1.attendanceService.clockIn(clockInData)).rejects.toThrow('Employee not found');
        });
    });
    describe('clockOut', () => {
        it('should handle clock out without clock in', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            const clockOutData = {
                employeeId: employee.id,
                qrCodeHash: 'test-qr-hash',
                timestamp: new Date('2025-01-15T12:00:00Z'),
                selfieImagePath: '/uploads/selfies/test-selfie-out.jpg'
            };
            // Act & Assert
            await expect(attendanceService_1.attendanceService.clockOut(clockOutData)).rejects.toThrow();
        });
    });
    describe('getAttendanceSummary', () => {
        it('should get attendance summary for employee and date', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            const date = new Date('2025-01-15');
            // Act
            const result = await attendanceService_1.attendanceService.getAttendanceSummary(employee.id, date);
            // Assert
            expect(result).toHaveProperty('employeeId');
            expect(result).toHaveProperty('date');
            expect(result.employeeId).toBe(employee.id);
        });
    });
    describe('getEmployeeAttendanceHistory', () => {
        it('should get attendance history for employee', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            const startDate = new Date('2025-01-01');
            const endDate = new Date('2025-01-31');
            // Act
            const result = await attendanceService_1.attendanceService.getEmployeeAttendanceHistory(employee.id, startDate, endDate);
            // Assert
            expect(result).toHaveProperty('records');
            expect(result).toHaveProperty('total');
            expect(result).toHaveProperty('page');
            expect(Array.isArray(result.records)).toBe(true);
            expect(typeof result.total).toBe('number');
            expect(typeof result.page).toBe('number');
        });
    });
    describe('getEmployeeAttendanceStats', () => {
        it('should get attendance stats for employee', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            const startDate = new Date('2025-01-01');
            const endDate = new Date('2025-01-31');
            // Act
            const result = await attendanceService_1.attendanceService.getEmployeeAttendanceStats(employee.id, startDate, endDate);
            // Assert
            expect(result).toHaveProperty('totalDays');
            expect(result).toHaveProperty('presentDays');
            expect(result).toHaveProperty('lateDays');
            expect(result).toHaveProperty('absentDays');
            expect(result).toHaveProperty('totalHours');
            expect(typeof result.totalDays).toBe('number');
            expect(typeof result.presentDays).toBe('number');
            expect(typeof result.lateDays).toBe('number');
            expect(typeof result.absentDays).toBe('number');
            expect(typeof result.totalHours).toBe('number');
        });
    });
    describe('getAttendanceRecords', () => {
        it('should get attendance records', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            const startDate = new Date('2025-01-01');
            const endDate = new Date('2025-01-31');
            // Act
            const result = await attendanceService_1.attendanceService.getAttendanceRecords(startDate, endDate);
            // Assert
            expect(result).toHaveProperty('records');
            expect(result).toHaveProperty('total');
            expect(Array.isArray(result.records)).toBe(true);
            expect(typeof result.total).toBe('number');
        });
    });
    describe('validateAttendanceAction', () => {
        it('should validate attendance action', async () => {
            // Act
            const result = await attendanceService_1.attendanceService.validateAttendanceAction('valid-employee-id', 'morning_in');
            // Assert
            expect(result).toHaveProperty('canPerform');
            expect(typeof result.canPerform).toBe('boolean');
        });
    });
    describe('verifyQRCode', () => {
        it('should verify QR code', async () => {
            // Act
            const result = await attendanceService_1.attendanceService.verifyQRCode('test-qr-hash');
            // Assert
            expect(result).toHaveProperty('isValid');
            expect(typeof result.isValid).toBe('boolean');
        });
    });
    describe('getCurrentAttendanceStatus', () => {
        it('should get current attendance status', async () => {
            // Arrange
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            const employee = await testHelpers.createTestEmployee({
                departmentId: department.id,
                employmentType: 'regular'
            });
            createdEmployeeIds.push(employee.id);
            createdUserIds.push(employee.userId);
            // Act
            const result = await attendanceService_1.attendanceService.getCurrentAttendanceStatus(employee.id);
            // Assert
            expect(result).toHaveProperty('isClockedIn');
            expect(result).toHaveProperty('lastClockIn');
            expect(result).toHaveProperty('lastClockOut');
            expect(result).toHaveProperty('todayHours');
            expect(result).toHaveProperty('todayStatus');
            expect(typeof result.isClockedIn).toBe('boolean');
            expect(typeof result.todayHours).toBe('number');
            // todayStatus might be undefined if attendanceRecord.overallStatus is not set
            // This is acceptable for the mock database service
            expect(result.todayStatus === undefined || typeof result.todayStatus === 'string').toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva2ltL3RpdG8vc2VydmVyL3Rlc3RzL3VuaXQvc2VydmljZXMvYXR0ZW5kYW5jZVNlcnZpY2UudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDBGQUF1RjtBQUN2Rix5REFBc0Q7QUFDdEQsdUNBQXdEO0FBRXhELFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFDakMsSUFBSSxXQUF3QixDQUFDO0lBQzdCLElBQUksY0FBYyxHQUFhLEVBQUUsQ0FBQztJQUNsQyxJQUFJLGtCQUFrQixHQUFhLEVBQUUsQ0FBQztJQUN0QyxJQUFJLG9CQUFvQixHQUFhLEVBQUUsQ0FBQztJQUV4QyxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLE1BQU0sSUFBQSxpQ0FBeUIsR0FBRSxDQUFDO1FBQ3pELFdBQVcsR0FBRyxJQUFJLHlCQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsd0NBQXdDO1FBQ3hDLEtBQUssTUFBTSxVQUFVLElBQUksa0JBQWtCLEVBQUUsQ0FBQztZQUM1QyxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxXQUFXLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQy9DLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLHdCQUF3QjtZQUMxQixDQUFDO1FBQ0gsQ0FBQztRQUNELEtBQUssTUFBTSxNQUFNLElBQUksY0FBYyxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDO2dCQUNILE1BQU0sV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN2QyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZix3QkFBd0I7WUFDMUIsQ0FBQztRQUNILENBQUM7UUFDRCxLQUFLLE1BQU0sWUFBWSxJQUFJLG9CQUFvQixFQUFFLENBQUM7WUFDaEQsSUFBSSxDQUFDO2dCQUNILE1B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LENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUva2ltL3RpdG8vc2VydmVyL3Rlc3RzL3VuaXQvc2VydmljZXMvYXR0ZW5kYW5jZVNlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhdHRlbmRhbmNlU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NyYy9zZXJ2aWNlcy9hdHRlbmRhbmNlL2F0dGVuZGFuY2VTZXJ2aWNlJztcbmltcG9ydCB7IFRlc3RIZWxwZXJzIH0gZnJvbSAnLi4vLi4vdXRpbHMvdGVzdEhlbHBlcnMnO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZVRlc3RDb25uZWN0aW9ucyB9IGZyb20gJy4uLy4uL3NldHVwJztcblxuZGVzY3JpYmUoJ0F0dGVuZGFuY2VTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgdGVzdEhlbHBlcnM6IFRlc3RIZWxwZXJzO1xuICBsZXQgY3JlYXRlZFVzZXJJZHM6IHN0cmluZ1tdID0gW107XG4gIGxldCBjcmVhdGVkRW1wbG95ZWVJZHM6IHN0cmluZ1tdID0gW107XG4gIGxldCBjcmVhdGVkRGVwYXJ0bWVudElkczogc3RyaW5nW10gPSBbXTtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgdGVzdERiUG9vbCB9ID0gYXdhaXQgaW5pdGlhbGl6ZVRlc3RDb25uZWN0aW9ucygpO1xuICAgIHRlc3RIZWxwZXJzID0gbmV3IFRlc3RIZWxwZXJzKHRlc3REYlBvb2wpO1xuICB9KTtcblxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIENsZWFuIHVwIGNyZWF0ZWQgZGF0YSBhZnRlciBlYWNoIHRlc3RcbiAgICBmb3IgKGNvbnN0IGVtcGxveWVlSWQgb2YgY3JlYXRlZEVtcGxveWVlSWRzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0ZXN0SGVscGVycy5kZWxldGVFbXBsb3llZShlbXBsb3llZUlkKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIElnbm9yZSBjbGVhbnVwIGVycm9yc1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IHVzZXJJZCBvZiBjcmVhdGVkVXNlcklkcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGVzdEhlbHBlcnMuZGVsZXRlVXNlcih1c2VySWQpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gSWdub3JlIGNsZWFudXAgZXJyb3JzXG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoY29uc3QgZGVwYXJ0bWVudElkIG9mIGNyZWF0ZWREZXBhcnRtZW50SWRzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0ZXN0SGVscGVycy5kZWxldGVEZXBhcnRtZW50KGRlcGFydG1lbnRJZCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBJZ25vcmUgY2xlYW51cCBlcnJvcnNcbiAgICAgIH1cbiAgICB9XG4gICAgY3JlYXRlZFVzZXJJZHMgPSBbXTtcbiAgICBjcmVhdGVkRW1wbG95ZWVJZHMgPSBbXTtcbiAgICBjcmVhdGVkRGVwYXJ0bWVudElkcyA9IFtdO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2xvY2tJbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBjbG9jayBpbiBlbXBsb3llZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGRlcGFydG1lbnQgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RGVwYXJ0bWVudCgpO1xuICAgICAgY3JlYXRlZERlcGFydG1lbnRJZHMucHVzaChkZXBhcnRtZW50LmlkKTtcbiAgICAgIFxuICAgICAgY29uc3QgZW1wbG95ZWUgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RW1wbG95ZWUoe1xuICAgICAgICBkZXBhcnRtZW50SWQ6IGRlcGFydG1lbnQuaWQsXG4gICAgICAgIGVtcGxveW1lbnRUeXBlOiAncmVndWxhcidcbiAgICAgIH0pO1xuICAgICAgY3JlYXRlZEVtcGxveWVlSWRzLnB1c2goZW1wbG95ZWUuaWQpO1xuICAgICAgY3JlYXRlZFVzZXJJZHMucHVzaChlbXBsb3llZS51c2VySWQpO1xuXG4gICAgICBjb25zdCBjbG9ja0luRGF0YSA9IHtcbiAgICAgICAgZW1wbG95ZWVJZDogZW1wbG95ZWUuaWQsXG4gICAgICAgIHFyQ29kZUhhc2g6ICd0ZXN0LXFyLWhhc2gnLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCcyMDI1LTAxLTE1VDA4OjAwOjAwWicpLFxuICAgICAgICBzZWxmaWVJbWFnZVBhdGg6ICcvdXBsb2Fkcy9zZWxmaWVzL3Rlc3Qtc2VsZmllLmpwZydcbiAgICAgIH07XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXR0ZW5kYW5jZVNlcnZpY2UuY2xvY2tJbihjbG9ja0luRGF0YSk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ2VtcGxveWVlSWQnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdkYXRlJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnc2Vzc2lvbnMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZW1wbG95ZWVJZCkudG9CZShlbXBsb3llZS5pZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjbG9jayBpbiBmb3Igbm9uLWV4aXN0ZW50IGVtcGxveWVlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgY2xvY2tJbkRhdGEgPSB7XG4gICAgICAgIGVtcGxveWVlSWQ6ICdub24tZXhpc3RlbnQtaWQnLFxuICAgICAgICBxckNvZGVIYXNoOiAndGVzdC1xci1oYXNoJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgnMjAyNS0wMS0xNVQwODowMDowMFonKSxcbiAgICAgICAgc2VsZmllSW1hZ2VQYXRoOiAnL3VwbG9hZHMvc2VsZmllcy90ZXN0LXNlbGZpZS5qcGcnXG4gICAgICB9O1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChhdHRlbmRhbmNlU2VydmljZS5jbG9ja0luKGNsb2NrSW5EYXRhKSkucmVqZWN0cy50b1Rocm93KCdFbXBsb3llZSBub3QgZm91bmQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Nsb2NrT3V0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGNsb2NrIG91dCB3aXRob3V0IGNsb2NrIGluJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgZGVwYXJ0bWVudCA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3REZXBhcnRtZW50KCk7XG4gICAgICBjcmVhdGVkRGVwYXJ0bWVudElkcy5wdXNoKGRlcGFydG1lbnQuaWQpO1xuICAgICAgXG4gICAgICBjb25zdCBlbXBsb3llZSA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3RFbXBsb3llZSh7XG4gICAgICAgIGRlcGFydG1lbnRJZDogZGVwYXJ0bWVudC5pZCxcbiAgICAgICAgZW1wbG95bWVudFR5cGU6ICdyZWd1bGFyJ1xuICAgICAgfSk7XG4gICAgICBjcmVhdGVkRW1wbG95ZWVJZHMucHVzaChlbXBsb3llZS5pZCk7XG4gICAgICBjcmVhdGVkVXNlcklkcy5wdXNoKGVtcGxveWVlLnVzZXJJZCk7XG5cbiAgICAgIGNvbnN0IGNsb2NrT3V0RGF0YSA9IHtcbiAgICAgICAgZW1wbG95ZWVJZDogZW1wbG95ZWUuaWQsXG4gICAgICAgIHFyQ29kZUhhc2g6ICd0ZXN0LXFyLWhhc2gnLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCcyMDI1LTAxLTE1VDEyOjAwOjAwWicpLFxuICAgICAgICBzZWxmaWVJbWFnZVBhdGg6ICcvdXBsb2Fkcy9zZWxmaWVzL3Rlc3Qtc2VsZmllLW91dC5qcGcnXG4gICAgICB9O1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChhdHRlbmRhbmNlU2VydmljZS5jbG9ja091dChjbG9ja091dERhdGEpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldEF0dGVuZGFuY2VTdW1tYXJ5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2V0IGF0dGVuZGFuY2Ugc3VtbWFyeSBmb3IgZW1wbG95ZWUgYW5kIGRhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBkZXBhcnRtZW50ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoKTtcbiAgICAgIGNyZWF0ZWREZXBhcnRtZW50SWRzLnB1c2goZGVwYXJ0bWVudC5pZCk7XG4gICAgICBcbiAgICAgIGNvbnN0IGVtcGxveWVlID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdEVtcGxveWVlKHtcbiAgICAgICAgZGVwYXJ0bWVudElkOiBkZXBhcnRtZW50LmlkLFxuICAgICAgICBlbXBsb3ltZW50VHlwZTogJ3JlZ3VsYXInXG4gICAgICB9KTtcbiAgICAgIGNyZWF0ZWRFbXBsb3llZUlkcy5wdXNoKGVtcGxveWVlLmlkKTtcbiAgICAgIGNyZWF0ZWRVc2VySWRzLnB1c2goZW1wbG95ZWUudXNlcklkKTtcblxuICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCcyMDI1LTAxLTE1Jyk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXR0ZW5kYW5jZVNlcnZpY2UuZ2V0QXR0ZW5kYW5jZVN1bW1hcnkoZW1wbG95ZWUuaWQsIGRhdGUpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdlbXBsb3llZUlkJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnZGF0ZScpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lbXBsb3llZUlkKS50b0JlKGVtcGxveWVlLmlkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldEVtcGxveWVlQXR0ZW5kYW5jZUhpc3RvcnknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBnZXQgYXR0ZW5kYW5jZSBoaXN0b3J5IGZvciBlbXBsb3llZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGRlcGFydG1lbnQgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RGVwYXJ0bWVudCgpO1xuICAgICAgY3JlYXRlZERlcGFydG1lbnRJZHMucHVzaChkZXBhcnRtZW50LmlkKTtcbiAgICAgIFxuICAgICAgY29uc3QgZW1wbG95ZWUgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RW1wbG95ZWUoe1xuICAgICAgICBkZXBhcnRtZW50SWQ6IGRlcGFydG1lbnQuaWQsXG4gICAgICAgIGVtcGxveW1lbnRUeXBlOiAncmVndWxhcidcbiAgICAgIH0pO1xuICAgICAgY3JlYXRlZEVtcGxveWVlSWRzLnB1c2goZW1wbG95ZWUuaWQpO1xuICAgICAgY3JlYXRlZFVzZXJJZHMucHVzaChlbXBsb3llZS51c2VySWQpO1xuXG4gICAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZSgnMjAyNS0wMS0wMScpO1xuICAgICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKCcyMDI1LTAxLTMxJyk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXR0ZW5kYW5jZVNlcnZpY2UuZ2V0RW1wbG95ZWVBdHRlbmRhbmNlSGlzdG9yeShlbXBsb3llZS5pZCwgc3RhcnREYXRlLCBlbmREYXRlKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgncmVjb3JkcycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3RvdGFsJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgncGFnZScpO1xuICAgICAgZXhwZWN0KEFycmF5LmlzQXJyYXkocmVzdWx0LnJlY29yZHMpKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQudG90YWwpLnRvQmUoJ251bWJlcicpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQucGFnZSkudG9CZSgnbnVtYmVyJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRFbXBsb3llZUF0dGVuZGFuY2VTdGF0cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdldCBhdHRlbmRhbmNlIHN0YXRzIGZvciBlbXBsb3llZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGRlcGFydG1lbnQgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RGVwYXJ0bWVudCgpO1xuICAgICAgY3JlYXRlZERlcGFydG1lbnRJZHMucHVzaChkZXBhcnRtZW50LmlkKTtcbiAgICAgIFxuICAgICAgY29uc3QgZW1wbG95ZWUgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RW1wbG95ZWUoe1xuICAgICAgICBkZXBhcnRtZW50SWQ6IGRlcGFydG1lbnQuaWQsXG4gICAgICAgIGVtcGxveW1lbnRUeXBlOiAncmVndWxhcidcbiAgICAgIH0pO1xuICAgICAgY3JlYXRlZEVtcGxveWVlSWRzLnB1c2goZW1wbG95ZWUuaWQpO1xuICAgICAgY3JlYXRlZFVzZXJJZHMucHVzaChlbXBsb3llZS51c2VySWQpO1xuXG4gICAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZSgnMjAyNS0wMS0wMScpO1xuICAgICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKCcyMDI1LTAxLTMxJyk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXR0ZW5kYW5jZVNlcnZpY2UuZ2V0RW1wbG95ZWVBdHRlbmRhbmNlU3RhdHMoZW1wbG95ZWUuaWQsIHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3RvdGFsRGF5cycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3ByZXNlbnREYXlzJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnbGF0ZURheXMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdhYnNlbnREYXlzJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgndG90YWxIb3VycycpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQudG90YWxEYXlzKS50b0JlKCdudW1iZXInKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0LnByZXNlbnREYXlzKS50b0JlKCdudW1iZXInKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0LmxhdGVEYXlzKS50b0JlKCdudW1iZXInKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0LmFic2VudERheXMpLnRvQmUoJ251bWJlcicpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQudG90YWxIb3VycykudG9CZSgnbnVtYmVyJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRBdHRlbmRhbmNlUmVjb3JkcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdldCBhdHRlbmRhbmNlIHJlY29yZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBkZXBhcnRtZW50ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoKTtcbiAgICAgIGNyZWF0ZWREZXBhcnRtZW50SWRzLnB1c2goZGVwYXJ0bWVudC5pZCk7XG4gICAgICBcbiAgICAgIGNvbnN0IGVtcGxveWVlID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdEVtcGxveWVlKHtcbiAgICAgICAgZGVwYXJ0bWVudElkOiBkZXBhcnRtZW50LmlkLFxuICAgICAgICBlbXBsb3ltZW50VHlwZTogJ3JlZ3VsYXInXG4gICAgICB9KTtcbiAgICAgIGNyZWF0ZWRFbXBsb3llZUlkcy5wdXNoKGVtcGxveWVlLmlkKTtcbiAgICAgIGNyZWF0ZWRVc2VySWRzLnB1c2goZW1wbG95ZWUudXNlcklkKTtcblxuICAgICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoJzIwMjUtMDEtMDEnKTtcbiAgICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZSgnMjAyNS0wMS0zMScpO1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF0dGVuZGFuY2VTZXJ2aWNlLmdldEF0dGVuZGFuY2VSZWNvcmRzKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3JlY29yZHMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbCcpO1xuICAgICAgZXhwZWN0KEFycmF5LmlzQXJyYXkocmVzdWx0LnJlY29yZHMpKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQudG90YWwpLnRvQmUoJ251bWJlcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndmFsaWRhdGVBdHRlbmRhbmNlQWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgYXR0ZW5kYW5jZSBhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF0dGVuZGFuY2VTZXJ2aWNlLnZhbGlkYXRlQXR0ZW5kYW5jZUFjdGlvbigndmFsaWQtZW1wbG95ZWUtaWQnLCAnbW9ybmluZ19pbicpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdjYW5QZXJmb3JtJyk7XG4gICAgICBleHBlY3QodHlwZW9mIHJlc3VsdC5jYW5QZXJmb3JtKS50b0JlKCdib29sZWFuJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd2ZXJpZnlRUkNvZGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB2ZXJpZnkgUVIgY29kZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXR0ZW5kYW5jZVNlcnZpY2UudmVyaWZ5UVJDb2RlKCd0ZXN0LXFyLWhhc2gnKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnaXNWYWxpZCcpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQuaXNWYWxpZCkudG9CZSgnYm9vbGVhbicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0Q3VycmVudEF0dGVuZGFuY2VTdGF0dXMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBnZXQgY3VycmVudCBhdHRlbmRhbmNlIHN0YXR1cycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGRlcGFydG1lbnQgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RGVwYXJ0bWVudCgpO1xuICAgICAgY3JlYXRlZERlcGFydG1lbnRJZHMucHVzaChkZXBhcnRtZW50LmlkKTtcbiAgICAgIFxuICAgICAgY29uc3QgZW1wbG95ZWUgPSBhd2FpdCB0ZXN0SGVscGVycy5jcmVhdGVUZXN0RW1wbG95ZWUoe1xuICAgICAgICBkZXBhcnRtZW50SWQ6IGRlcGFydG1lbnQuaWQsXG4gICAgICAgIGVtcGxveW1lbnRUeXBlOiAncmVndWxhcidcbiAgICAgIH0pO1xuICAgICAgY3JlYXRlZEVtcGxveWVlSWRzLnB1c2goZW1wbG95ZWUuaWQpO1xuICAgICAgY3JlYXRlZFVzZXJJZHMucHVzaChlbXBsb3llZS51c2VySWQpO1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF0dGVuZGFuY2VTZXJ2aWNlLmdldEN1cnJlbnRBdHRlbmRhbmNlU3RhdHVzKGVtcGxveWVlLmlkKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnaXNDbG9ja2VkSW4nKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdsYXN0Q2xvY2tJbicpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ2xhc3RDbG9ja091dCcpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3RvZGF5SG91cnMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCd0b2RheVN0YXR1cycpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQuaXNDbG9ja2VkSW4pLnRvQmUoJ2Jvb2xlYW4nKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0LnRvZGF5SG91cnMpLnRvQmUoJ251bWJlcicpO1xuICAgICAgLy8gdG9kYXlTdGF0dXMgbWlnaHQgYmUgdW5kZWZpbmVkIGlmIGF0dGVuZGFuY2VSZWNvcmQub3ZlcmFsbFN0YXR1cyBpcyBub3Qgc2V0XG4gICAgICAvLyBUaGlzIGlzIGFjY2VwdGFibGUgZm9yIHRoZSBtb2NrIGRhdGFiYXNlIHNlcnZpY2VcbiAgICAgIGV4cGVjdChyZXN1bHQudG9kYXlTdGF0dXMgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgcmVzdWx0LnRvZGF5U3RhdHVzID09PSAnc3RyaW5nJykudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=