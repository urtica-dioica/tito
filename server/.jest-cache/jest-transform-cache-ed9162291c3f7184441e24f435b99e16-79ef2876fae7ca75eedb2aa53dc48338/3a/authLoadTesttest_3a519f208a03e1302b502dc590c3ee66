074aa77a8d58b2aa0d04cca9f7ec436b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const loadTestUtils_1 = require("./loadTestUtils");
const axios = {
    create: () => ({
        get: jest.fn(),
        post: jest.fn(),
        put: jest.fn(),
        delete: jest.fn(),
        patch: jest.fn(),
        interceptors: {
            request: { use: jest.fn() },
            response: { use: jest.fn() }
        }
    })
};
describe('Authentication Load Tests', () => {
    let loadTestRunner;
    let baseURL;
    beforeAll(() => {
        baseURL = process.env.TEST_BASE_URL || 'http://localhost:3000';
        const config = {
            baseURL,
            concurrentUsers: 10,
            requestsPerUser: 5,
            rampUpTime: 2000, // 2 seconds
            testDuration: 30000, // 30 seconds
            timeout: 10000 // 10 seconds
        };
        loadTestRunner = new loadTestUtils_1.LoadTestRunner(config);
    });
    describe('Login Endpoint Load Test', () => {
        it('should handle concurrent login requests', async () => {
            const testCredentials = {
                email: 'test@example.com',
                password: 'password123'
            };
            const requestFunction = async (axios) => {
                return axios.create().post('/api/v1/auth/login', testCredentials);
            };
            const result = await loadTestRunner.runLoadTest(requestFunction, 'Login Endpoint Load Test');
            // Performance assertions
            expect(result.averageResponseTime).toBeLessThan(2000); // Less than 2 seconds
            expect(result.errorRate).toBeLessThan(0.05); // Less than 5% error rate
            expect(result.requestsPerSecond).toBeGreaterThan(5); // At least 5 RPS
            console.log(loadTestRunner.generateReport(result, 'Login Endpoint Load Test'));
        }, 60000); // 60 second timeout
    });
    describe('Token Validation Load Test', () => {
        let authToken;
        beforeAll(async () => {
            // Get a valid token for testing
            try {
                const response = await axios.create().post(`${baseURL}/api/v1/auth/login`, {
                    email: 'test@example.com',
                    password: 'password123'
                });
                authToken = response.data.data.accessToken;
            }
            catch (error) {
                console.warn('Could not obtain auth token for load test');
                authToken = 'invalid-token';
            }
        });
        it('should handle concurrent token validation requests', async () => {
            const requestFunction = async (axios) => {
                return axios.create().get('/api/v1/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            };
            const result = await loadTestRunner.runLoadTest(requestFunction, 'Token Validation Load Test');
            // Performance assertions
            expect(result.averageResponseTime).toBeLessThan(1000); // Less than 1 second
            expect(result.errorRate).toBeLessThan(0.1); // Less than 10% error rate
            expect(result.requestsPerSecond).toBeGreaterThan(10); // At least 10 RPS
            console.log(loadTestRunner.generateReport(result, 'Token Validation Load Test'));
        }, 60000);
    });
    describe('Refresh Token Load Test', () => {
        let refreshToken;
        beforeAll(async () => {
            // Get a valid refresh token for testing
            try {
                const response = await axios.create().post(`${baseURL}/api/v1/auth/login`, {
                    email: 'test@example.com',
                    password: 'password123'
                });
                refreshToken = response.data.data.refreshToken;
            }
            catch (error) {
                console.warn('Could not obtain refresh token for load test');
                refreshToken = 'invalid-refresh-token';
            }
        });
        it('should handle concurrent refresh token requests', async () => {
            const requestFunction = async (axios) => {
                return axios.create().post('/api/v1/auth/refresh', {}, {
                    headers: {
                        'Cookie': `refreshToken=${refreshToken}`
                    }
                });
            };
            const result = await loadTestRunner.runLoadTest(requestFunction, 'Refresh Token Load Test');
            // Performance assertions
            expect(result.averageResponseTime).toBeLessThan(1500); // Less than 1.5 seconds
            expect(result.errorRate).toBeLessThan(0.1); // Less than 10% error rate
            expect(result.requestsPerSecond).toBeGreaterThan(8); // At least 8 RPS
            console.log(loadTestRunner.generateReport(result, 'Refresh Token Load Test'));
        }, 60000);
    });
    describe('High Load Authentication Test', () => {
        it('should handle high concurrent load on authentication endpoints', async () => {
            const highLoadConfig = {
                baseURL,
                concurrentUsers: 50,
                requestsPerUser: 10,
                rampUpTime: 5000, // 5 seconds
                testDuration: 60000, // 60 seconds
                timeout: 15000 // 15 seconds
            };
            const highLoadRunner = new loadTestUtils_1.LoadTestRunner(highLoadConfig);
            const testCredentials = {
                email: 'test@example.com',
                password: 'password123'
            };
            const requestFunction = async (axios) => {
                return axios.create().post('/api/v1/auth/login', testCredentials);
            };
            const result = await highLoadRunner.runLoadTest(requestFunction, 'High Load Authentication Test');
            // High load performance assertions
            expect(result.averageResponseTime).toBeLessThan(3000); // Less than 3 seconds
            expect(result.errorRate).toBeLessThan(0.1); // Less than 10% error rate
            expect(result.requestsPerSecond).toBeGreaterThan(20); // At least 20 RPS
            expect(result.totalRequests).toBe(500); // 50 users * 10 requests each
            console.log(highLoadRunner.generateReport(result, 'High Load Authentication Test'));
        }, 120000); // 2 minute timeout
    });
    describe('Authentication Stress Test', () => {
        it('should handle stress conditions on authentication endpoints', async () => {
            const stressConfig = {
                baseURL,
                concurrentUsers: 100,
                requestsPerUser: 20,
                rampUpTime: 10000, // 10 seconds
                testDuration: 120000, // 2 minutes
                timeout: 20000 // 20 seconds
            };
            const stressRunner = new loadTestUtils_1.LoadTestRunner(stressConfig);
            const testCredentials = {
                email: 'test@example.com',
                password: 'password123'
            };
            const requestFunction = async (axios) => {
                return axios.create().post('/api/v1/auth/login', testCredentials);
            };
            const result = await stressRunner.runLoadTest(requestFunction, 'Authentication Stress Test');
            // Stress test performance assertions (more lenient)
            expect(result.averageResponseTime).toBeLessThan(5000); // Less than 5 seconds
            expect(result.errorRate).toBeLessThan(0.2); // Less than 20% error rate
            expect(result.requestsPerSecond).toBeGreaterThan(10); // At least 10 RPS
            expect(result.totalRequests).toBe(2000); // 100 users * 20 requests each
            console.log(stressRunner.generateReport(result, 'Authentication Stress Test'));
        }, 180000); // 3 minute timeout
    });
    describe('Authentication Endpoint Comparison', () => {
        it('should compare performance across different authentication endpoints', async () => {
            const endpoints = [
                { name: 'Login', path: '/api/v1/auth/login', method: 'POST' },
                { name: 'Profile', path: '/api/v1/auth/profile', method: 'GET' },
                { name: 'Refresh', path: '/api/v1/auth/refresh', method: 'POST' }
            ];
            const results = {};
            for (const endpoint of endpoints) {
                const requestFunction = async (axios) => {
                    const data = endpoint.method === 'POST' ?
                        (endpoint.path.includes('login') ?
                            { email: 'test@example.com', password: 'password123' } :
                            {}) :
                        undefined;
                    const config = {
                        method: endpoint.method.toLowerCase(),
                        url: endpoint.path
                    };
                    if (data) {
                        config.data = data;
                    }
                    if (endpoint.path.includes('profile')) {
                        config.headers = {
                            'Authorization': 'Bearer test-token'
                        };
                    }
                    if (endpoint.path.includes('refresh')) {
                        config.headers = {
                            'Cookie': 'refreshToken=test-refresh-token'
                        };
                    }
                    return axios(config);
                };
                const result = await loadTestRunner.runLoadTest(requestFunction, `${endpoint.name} Endpoint Performance`);
                results[endpoint.name] = result;
            }
            // Compare results
            console.log('\nðŸ“Š AUTHENTICATION ENDPOINT COMPARISON');
            console.log('=====================================');
            for (const [name, result] of Object.entries(results)) {
                console.log(`\n${name}:`);
                console.log(`  Average Response Time: ${result.averageResponseTime.toFixed(2)}ms`);
                console.log(`  Error Rate: ${(result.errorRate * 100).toFixed(2)}%`);
                console.log(`  Requests/Second: ${result.requestsPerSecond.toFixed(2)}`);
            }
            // Assertions for endpoint comparison
            expect(results.Login.averageResponseTime).toBeLessThan(2000);
            expect(results.Profile.averageResponseTime).toBeLessThan(1000);
            expect(results.Refresh.averageResponseTime).toBeLessThan(1500);
        }, 180000);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva2ltL3RpdG8vc2VydmVyL3Rlc3RzL3BlcmZvcm1hbmNlL2F1dGhMb2FkVGVzdC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsbURBQWlGO0FBT2pGLE1BQU0sS0FBSyxHQUFHO0lBQ1osTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDYixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNkLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2YsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNqQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixZQUFZLEVBQUU7WUFDWixPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQzNCLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUU7U0FDN0I7S0FDRixDQUFDO0NBQ0gsQ0FBQztBQUVGLFFBQVEsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7SUFDekMsSUFBSSxjQUE4QixDQUFDO0lBQ25DLElBQUksT0FBZSxDQUFDO0lBRXBCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLElBQUksdUJBQXVCLENBQUM7UUFFL0QsTUFBTSxNQUFNLEdBQW1CO1lBQzdCLE9BQU87WUFDUCxlQUFlLEVBQUUsRUFBRTtZQUNuQixlQUFlLEVBQUUsQ0FBQztZQUNsQixVQUFVLEVBQUUsSUFBSSxFQUFFLFlBQVk7WUFDOUIsWUFBWSxFQUFFLEtBQUssRUFBRSxhQUFhO1lBQ2xDLE9BQU8sRUFBRSxLQUFLLENBQUMsYUFBYTtTQUM3QixDQUFDO1FBRUYsY0FBYyxHQUFHLElBQUksOEJBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEs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QUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9ELE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pFLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUva2ltL3RpdG8vc2VydmVyL3Rlc3RzL3BlcmZvcm1hbmNlL2F1dGhMb2FkVGVzdC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvYWRUZXN0UnVubmVyLCBMb2FkVGVzdENvbmZpZywgTG9hZFRlc3RSZXN1bHQgfSBmcm9tICcuL2xvYWRUZXN0VXRpbHMnO1xuLy8gTW9jayBheGlvcyBmb3IgdGVzdGluZ1xuaW50ZXJmYWNlIEF4aW9zUmVzcG9uc2Uge1xuICBzdGF0dXM6IG51bWJlcjtcbiAgZGF0YTogYW55O1xufVxuXG5jb25zdCBheGlvcyA9IHtcbiAgY3JlYXRlOiAoKSA9PiAoe1xuICAgIGdldDogamVzdC5mbigpLFxuICAgIHBvc3Q6IGplc3QuZm4oKSxcbiAgICBwdXQ6IGplc3QuZm4oKSxcbiAgICBkZWxldGU6IGplc3QuZm4oKSxcbiAgICBwYXRjaDogamVzdC5mbigpLFxuICAgIGludGVyY2VwdG9yczoge1xuICAgICAgcmVxdWVzdDogeyB1c2U6IGplc3QuZm4oKSB9LFxuICAgICAgcmVzcG9uc2U6IHsgdXNlOiBqZXN0LmZuKCkgfVxuICAgIH1cbiAgfSlcbn07XG5cbmRlc2NyaWJlKCdBdXRoZW50aWNhdGlvbiBMb2FkIFRlc3RzJywgKCkgPT4ge1xuICBsZXQgbG9hZFRlc3RSdW5uZXI6IExvYWRUZXN0UnVubmVyO1xuICBsZXQgYmFzZVVSTDogc3RyaW5nO1xuXG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgYmFzZVVSTCA9IHByb2Nlc3MuZW52LlRFU1RfQkFTRV9VUkwgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCc7XG4gICAgXG4gICAgY29uc3QgY29uZmlnOiBMb2FkVGVzdENvbmZpZyA9IHtcbiAgICAgIGJhc2VVUkwsXG4gICAgICBjb25jdXJyZW50VXNlcnM6IDEwLFxuICAgICAgcmVxdWVzdHNQZXJVc2VyOiA1LFxuICAgICAgcmFtcFVwVGltZTogMjAwMCwgLy8gMiBzZWNvbmRzXG4gICAgICB0ZXN0RHVyYXRpb246IDMwMDAwLCAvLyAzMCBzZWNvbmRzXG4gICAgICB0aW1lb3V0OiAxMDAwMCAvLyAxMCBzZWNvbmRzXG4gICAgfTtcbiAgICBcbiAgICBsb2FkVGVzdFJ1bm5lciA9IG5ldyBMb2FkVGVzdFJ1bm5lcihjb25maWcpO1xuICB9KTtcblxuICBkZXNjcmliZSgnTG9naW4gRW5kcG9pbnQgTG9hZCBUZXN0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGNvbmN1cnJlbnQgbG9naW4gcmVxdWVzdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXN0Q3JlZGVudGlhbHMgPSB7XG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXF1ZXN0RnVuY3Rpb24gPSBhc3luYyAoYXhpb3M6IGFueSk6IFByb21pc2U8QXhpb3NSZXNwb25zZT4gPT4ge1xuICAgICAgICByZXR1cm4gYXhpb3MuY3JlYXRlKCkucG9zdCgnL2FwaS92MS9hdXRoL2xvZ2luJywgdGVzdENyZWRlbnRpYWxzKTtcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdDogTG9hZFRlc3RSZXN1bHQgPSBhd2FpdCBsb2FkVGVzdFJ1bm5lci5ydW5Mb2FkVGVzdChcbiAgICAgICAgcmVxdWVzdEZ1bmN0aW9uLFxuICAgICAgICAnTG9naW4gRW5kcG9pbnQgTG9hZCBUZXN0J1xuICAgICAgKTtcblxuICAgICAgLy8gUGVyZm9ybWFuY2UgYXNzZXJ0aW9uc1xuICAgICAgZXhwZWN0KHJlc3VsdC5hdmVyYWdlUmVzcG9uc2VUaW1lKS50b0JlTGVzc1RoYW4oMjAwMCk7IC8vIExlc3MgdGhhbiAyIHNlY29uZHNcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oMC4wNSk7IC8vIExlc3MgdGhhbiA1JSBlcnJvciByYXRlXG4gICAgICBleHBlY3QocmVzdWx0LnJlcXVlc3RzUGVyU2Vjb25kKS50b0JlR3JlYXRlclRoYW4oNSk7IC8vIEF0IGxlYXN0IDUgUlBTXG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKGxvYWRUZXN0UnVubmVyLmdlbmVyYXRlUmVwb3J0KHJlc3VsdCwgJ0xvZ2luIEVuZHBvaW50IExvYWQgVGVzdCcpKTtcbiAgICB9LCA2MDAwMCk7IC8vIDYwIHNlY29uZCB0aW1lb3V0XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdUb2tlbiBWYWxpZGF0aW9uIExvYWQgVGVzdCcsICgpID0+IHtcbiAgICBsZXQgYXV0aFRva2VuOiBzdHJpbmc7XG5cbiAgICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR2V0IGEgdmFsaWQgdG9rZW4gZm9yIHRlc3RpbmdcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuY3JlYXRlKCkucG9zdChgJHtiYXNlVVJMfS9hcGkvdjEvYXV0aC9sb2dpbmAsIHtcbiAgICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnXG4gICAgICAgIH0pO1xuICAgICAgICBhdXRoVG9rZW4gPSByZXNwb25zZS5kYXRhLmRhdGEuYWNjZXNzVG9rZW47XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oJ0NvdWxkIG5vdCBvYnRhaW4gYXV0aCB0b2tlbiBmb3IgbG9hZCB0ZXN0Jyk7XG4gICAgICAgIGF1dGhUb2tlbiA9ICdpbnZhbGlkLXRva2VuJztcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGNvbmN1cnJlbnQgdG9rZW4gdmFsaWRhdGlvbiByZXF1ZXN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlcXVlc3RGdW5jdGlvbiA9IGFzeW5jIChheGlvczogYW55KTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlPiA9PiB7XG4gICAgICAgIHJldHVybiBheGlvcy5jcmVhdGUoKS5nZXQoJy9hcGkvdjEvYXV0aC9wcm9maWxlJywge1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2F1dGhUb2tlbn1gXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdDogTG9hZFRlc3RSZXN1bHQgPSBhd2FpdCBsb2FkVGVzdFJ1bm5lci5ydW5Mb2FkVGVzdChcbiAgICAgICAgcmVxdWVzdEZ1bmN0aW9uLFxuICAgICAgICAnVG9rZW4gVmFsaWRhdGlvbiBMb2FkIFRlc3QnXG4gICAgICApO1xuXG4gICAgICAvLyBQZXJmb3JtYW5jZSBhc3NlcnRpb25zXG4gICAgICBleHBlY3QocmVzdWx0LmF2ZXJhZ2VSZXNwb25zZVRpbWUpLnRvQmVMZXNzVGhhbigxMDAwKTsgLy8gTGVzcyB0aGFuIDEgc2Vjb25kXG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yUmF0ZSkudG9CZUxlc3NUaGFuKDAuMSk7IC8vIExlc3MgdGhhbiAxMCUgZXJyb3IgcmF0ZVxuICAgICAgZXhwZWN0KHJlc3VsdC5yZXF1ZXN0c1BlclNlY29uZCkudG9CZUdyZWF0ZXJUaGFuKDEwKTsgLy8gQXQgbGVhc3QgMTAgUlBTXG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKGxvYWRUZXN0UnVubmVyLmdlbmVyYXRlUmVwb3J0KHJlc3VsdCwgJ1Rva2VuIFZhbGlkYXRpb24gTG9hZCBUZXN0JykpO1xuICAgIH0sIDYwMDAwKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1JlZnJlc2ggVG9rZW4gTG9hZCBUZXN0JywgKCkgPT4ge1xuICAgIGxldCByZWZyZXNoVG9rZW46IHN0cmluZztcblxuICAgIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyBHZXQgYSB2YWxpZCByZWZyZXNoIHRva2VuIGZvciB0ZXN0aW5nXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmNyZWF0ZSgpLnBvc3QoYCR7YmFzZVVSTH0vYXBpL3YxL2F1dGgvbG9naW5gLCB7XG4gICAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmVmcmVzaFRva2VuID0gcmVzcG9uc2UuZGF0YS5kYXRhLnJlZnJlc2hUb2tlbjtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignQ291bGQgbm90IG9idGFpbiByZWZyZXNoIHRva2VuIGZvciBsb2FkIHRlc3QnKTtcbiAgICAgICAgcmVmcmVzaFRva2VuID0gJ2ludmFsaWQtcmVmcmVzaC10b2tlbic7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjb25jdXJyZW50IHJlZnJlc2ggdG9rZW4gcmVxdWVzdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXF1ZXN0RnVuY3Rpb24gPSBhc3luYyAoYXhpb3M6IGFueSk6IFByb21pc2U8QXhpb3NSZXNwb25zZT4gPT4ge1xuICAgICAgICByZXR1cm4gYXhpb3MuY3JlYXRlKCkucG9zdCgnL2FwaS92MS9hdXRoL3JlZnJlc2gnLCB7fSwge1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb29raWUnOiBgcmVmcmVzaFRva2VuPSR7cmVmcmVzaFRva2VufWBcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0OiBMb2FkVGVzdFJlc3VsdCA9IGF3YWl0IGxvYWRUZXN0UnVubmVyLnJ1bkxvYWRUZXN0KFxuICAgICAgICByZXF1ZXN0RnVuY3Rpb24sXG4gICAgICAgICdSZWZyZXNoIFRva2VuIExvYWQgVGVzdCdcbiAgICAgICk7XG5cbiAgICAgIC8vIFBlcmZvcm1hbmNlIGFzc2VydGlvbnNcbiAgICAgIGV4cGVjdChyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZUxlc3NUaGFuKDE1MDApOyAvLyBMZXNzIHRoYW4gMS41IHNlY29uZHNcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oMC4xKTsgLy8gTGVzcyB0aGFuIDEwJSBlcnJvciByYXRlXG4gICAgICBleHBlY3QocmVzdWx0LnJlcXVlc3RzUGVyU2Vjb25kKS50b0JlR3JlYXRlclRoYW4oOCk7IC8vIEF0IGxlYXN0IDggUlBTXG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKGxvYWRUZXN0UnVubmVyLmdlbmVyYXRlUmVwb3J0KHJlc3VsdCwgJ1JlZnJlc2ggVG9rZW4gTG9hZCBUZXN0JykpO1xuICAgIH0sIDYwMDAwKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0hpZ2ggTG9hZCBBdXRoZW50aWNhdGlvbiBUZXN0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGhpZ2ggY29uY3VycmVudCBsb2FkIG9uIGF1dGhlbnRpY2F0aW9uIGVuZHBvaW50cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGhpZ2hMb2FkQ29uZmlnOiBMb2FkVGVzdENvbmZpZyA9IHtcbiAgICAgICAgYmFzZVVSTCxcbiAgICAgICAgY29uY3VycmVudFVzZXJzOiA1MCxcbiAgICAgICAgcmVxdWVzdHNQZXJVc2VyOiAxMCxcbiAgICAgICAgcmFtcFVwVGltZTogNTAwMCwgLy8gNSBzZWNvbmRzXG4gICAgICAgIHRlc3REdXJhdGlvbjogNjAwMDAsIC8vIDYwIHNlY29uZHNcbiAgICAgICAgdGltZW91dDogMTUwMDAgLy8gMTUgc2Vjb25kc1xuICAgICAgfTtcblxuICAgICAgY29uc3QgaGlnaExvYWRSdW5uZXIgPSBuZXcgTG9hZFRlc3RSdW5uZXIoaGlnaExvYWRDb25maWcpO1xuXG4gICAgICBjb25zdCB0ZXN0Q3JlZGVudGlhbHMgPSB7XG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXF1ZXN0RnVuY3Rpb24gPSBhc3luYyAoYXhpb3M6IGFueSk6IFByb21pc2U8QXhpb3NSZXNwb25zZT4gPT4ge1xuICAgICAgICByZXR1cm4gYXhpb3MuY3JlYXRlKCkucG9zdCgnL2FwaS92MS9hdXRoL2xvZ2luJywgdGVzdENyZWRlbnRpYWxzKTtcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdDogTG9hZFRlc3RSZXN1bHQgPSBhd2FpdCBoaWdoTG9hZFJ1bm5lci5ydW5Mb2FkVGVzdChcbiAgICAgICAgcmVxdWVzdEZ1bmN0aW9uLFxuICAgICAgICAnSGlnaCBMb2FkIEF1dGhlbnRpY2F0aW9uIFRlc3QnXG4gICAgICApO1xuXG4gICAgICAvLyBIaWdoIGxvYWQgcGVyZm9ybWFuY2UgYXNzZXJ0aW9uc1xuICAgICAgZXhwZWN0KHJlc3VsdC5hdmVyYWdlUmVzcG9uc2VUaW1lKS50b0JlTGVzc1RoYW4oMzAwMCk7IC8vIExlc3MgdGhhbiAzIHNlY29uZHNcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oMC4xKTsgLy8gTGVzcyB0aGFuIDEwJSBlcnJvciByYXRlXG4gICAgICBleHBlY3QocmVzdWx0LnJlcXVlc3RzUGVyU2Vjb25kKS50b0JlR3JlYXRlclRoYW4oMjApOyAvLyBBdCBsZWFzdCAyMCBSUFNcbiAgICAgIGV4cGVjdChyZXN1bHQudG90YWxSZXF1ZXN0cykudG9CZSg1MDApOyAvLyA1MCB1c2VycyAqIDEwIHJlcXVlc3RzIGVhY2hcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coaGlnaExvYWRSdW5uZXIuZ2VuZXJhdGVSZXBvcnQocmVzdWx0LCAnSGlnaCBMb2FkIEF1dGhlbnRpY2F0aW9uIFRlc3QnKSk7XG4gICAgfSwgMTIwMDAwKTsgLy8gMiBtaW51dGUgdGltZW91dFxuICB9KTtcblxuICBkZXNjcmliZSgnQXV0aGVudGljYXRpb24gU3RyZXNzIFRlc3QnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyZXNzIGNvbmRpdGlvbnMgb24gYXV0aGVudGljYXRpb24gZW5kcG9pbnRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RyZXNzQ29uZmlnOiBMb2FkVGVzdENvbmZpZyA9IHtcbiAgICAgICAgYmFzZVVSTCxcbiAgICAgICAgY29uY3VycmVudFVzZXJzOiAxMDAsXG4gICAgICAgIHJlcXVlc3RzUGVyVXNlcjogMjAsXG4gICAgICAgIHJhbXBVcFRpbWU6IDEwMDAwLCAvLyAxMCBzZWNvbmRzXG4gICAgICAgIHRlc3REdXJhdGlvbjogMTIwMDAwLCAvLyAyIG1pbnV0ZXNcbiAgICAgICAgdGltZW91dDogMjAwMDAgLy8gMjAgc2Vjb25kc1xuICAgICAgfTtcblxuICAgICAgY29uc3Qgc3RyZXNzUnVubmVyID0gbmV3IExvYWRUZXN0UnVubmVyKHN0cmVzc0NvbmZpZyk7XG5cbiAgICAgIGNvbnN0IHRlc3RDcmVkZW50aWFscyA9IHtcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMydcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlcXVlc3RGdW5jdGlvbiA9IGFzeW5jIChheGlvczogYW55KTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlPiA9PiB7XG4gICAgICAgIHJldHVybiBheGlvcy5jcmVhdGUoKS5wb3N0KCcvYXBpL3YxL2F1dGgvbG9naW4nLCB0ZXN0Q3JlZGVudGlhbHMpO1xuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0OiBMb2FkVGVzdFJlc3VsdCA9IGF3YWl0IHN0cmVzc1J1bm5lci5ydW5Mb2FkVGVzdChcbiAgICAgICAgcmVxdWVzdEZ1bmN0aW9uLFxuICAgICAgICAnQXV0aGVudGljYXRpb24gU3RyZXNzIFRlc3QnXG4gICAgICApO1xuXG4gICAgICAvLyBTdHJlc3MgdGVzdCBwZXJmb3JtYW5jZSBhc3NlcnRpb25zIChtb3JlIGxlbmllbnQpXG4gICAgICBleHBlY3QocmVzdWx0LmF2ZXJhZ2VSZXNwb25zZVRpbWUpLnRvQmVMZXNzVGhhbig1MDAwKTsgLy8gTGVzcyB0aGFuIDUgc2Vjb25kc1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvclJhdGUpLnRvQmVMZXNzVGhhbigwLjIpOyAvLyBMZXNzIHRoYW4gMjAlIGVycm9yIHJhdGVcbiAgICAgIGV4cGVjdChyZXN1bHQucmVxdWVzdHNQZXJTZWNvbmQpLnRvQmVHcmVhdGVyVGhhbigxMCk7IC8vIEF0IGxlYXN0IDEwIFJQU1xuICAgICAgZXhwZWN0KHJlc3VsdC50b3RhbFJlcXVlc3RzKS50b0JlKDIwMDApOyAvLyAxMDAgdXNlcnMgKiAyMCByZXF1ZXN0cyBlYWNoXG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKHN0cmVzc1J1bm5lci5nZW5lcmF0ZVJlcG9ydChyZXN1bHQsICdBdXRoZW50aWNhdGlvbiBTdHJlc3MgVGVzdCcpKTtcbiAgICB9LCAxODAwMDApOyAvLyAzIG1pbnV0ZSB0aW1lb3V0XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBdXRoZW50aWNhdGlvbiBFbmRwb2ludCBDb21wYXJpc29uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY29tcGFyZSBwZXJmb3JtYW5jZSBhY3Jvc3MgZGlmZmVyZW50IGF1dGhlbnRpY2F0aW9uIGVuZHBvaW50cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVuZHBvaW50cyA9IFtcbiAgICAgICAgeyBuYW1lOiAnTG9naW4nLCBwYXRoOiAnL2FwaS92MS9hdXRoL2xvZ2luJywgbWV0aG9kOiAnUE9TVCcgfSxcbiAgICAgICAgeyBuYW1lOiAnUHJvZmlsZScsIHBhdGg6ICcvYXBpL3YxL2F1dGgvcHJvZmlsZScsIG1ldGhvZDogJ0dFVCcgfSxcbiAgICAgICAgeyBuYW1lOiAnUmVmcmVzaCcsIHBhdGg6ICcvYXBpL3YxL2F1dGgvcmVmcmVzaCcsIG1ldGhvZDogJ1BPU1QnIH1cbiAgICAgIF07XG5cbiAgICAgIGNvbnN0IHJlc3VsdHM6IHsgW2tleTogc3RyaW5nXTogTG9hZFRlc3RSZXN1bHQgfSA9IHt9O1xuXG4gICAgICBmb3IgKGNvbnN0IGVuZHBvaW50IG9mIGVuZHBvaW50cykge1xuICAgICAgICBjb25zdCByZXF1ZXN0RnVuY3Rpb24gPSBhc3luYyAoYXhpb3M6IGFueSk6IFByb21pc2U8QXhpb3NSZXNwb25zZT4gPT4ge1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSBlbmRwb2ludC5tZXRob2QgPT09ICdQT1NUJyA/IFxuICAgICAgICAgICAgKGVuZHBvaW50LnBhdGguaW5jbHVkZXMoJ2xvZ2luJykgPyBcbiAgICAgICAgICAgICAgeyBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLCBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJyB9IDogXG4gICAgICAgICAgICAgIHt9KSA6IFxuICAgICAgICAgICAgdW5kZWZpbmVkO1xuXG4gICAgICAgICAgY29uc3QgY29uZmlnOiBhbnkgPSB7XG4gICAgICAgICAgICBtZXRob2Q6IGVuZHBvaW50Lm1ldGhvZC50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgdXJsOiBlbmRwb2ludC5wYXRoXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBjb25maWcuZGF0YSA9IGRhdGE7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGVuZHBvaW50LnBhdGguaW5jbHVkZXMoJ3Byb2ZpbGUnKSkge1xuICAgICAgICAgICAgY29uZmlnLmhlYWRlcnMgPSB7XG4gICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogJ0JlYXJlciB0ZXN0LXRva2VuJ1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoZW5kcG9pbnQucGF0aC5pbmNsdWRlcygncmVmcmVzaCcpKSB7XG4gICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IHtcbiAgICAgICAgICAgICAgJ0Nvb2tpZSc6ICdyZWZyZXNoVG9rZW49dGVzdC1yZWZyZXNoLXRva2VuJ1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gYXhpb3MoY29uZmlnKTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBsb2FkVGVzdFJ1bm5lci5ydW5Mb2FkVGVzdChcbiAgICAgICAgICByZXF1ZXN0RnVuY3Rpb24sXG4gICAgICAgICAgYCR7ZW5kcG9pbnQubmFtZX0gRW5kcG9pbnQgUGVyZm9ybWFuY2VgXG4gICAgICAgICk7XG5cbiAgICAgICAgcmVzdWx0c1tlbmRwb2ludC5uYW1lXSA9IHJlc3VsdDtcbiAgICAgIH1cblxuICAgICAgLy8gQ29tcGFyZSByZXN1bHRzXG4gICAgICBjb25zb2xlLmxvZygnXFxu8J+TiiBBVVRIRU5USUNBVElPTiBFTkRQT0lOVCBDT01QQVJJU09OJyk7XG4gICAgICBjb25zb2xlLmxvZygnPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PScpO1xuICAgICAgXG4gICAgICBmb3IgKGNvbnN0IFtuYW1lLCByZXN1bHRdIG9mIE9iamVjdC5lbnRyaWVzKHJlc3VsdHMpKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBcXG4ke25hbWV9OmApO1xuICAgICAgICBjb25zb2xlLmxvZyhgICBBdmVyYWdlIFJlc3BvbnNlIFRpbWU6ICR7cmVzdWx0LmF2ZXJhZ2VSZXNwb25zZVRpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgICBjb25zb2xlLmxvZyhgICBFcnJvciBSYXRlOiAkeyhyZXN1bHQuZXJyb3JSYXRlICogMTAwKS50b0ZpeGVkKDIpfSVgKTtcbiAgICAgICAgY29uc29sZS5sb2coYCAgUmVxdWVzdHMvU2Vjb25kOiAke3Jlc3VsdC5yZXF1ZXN0c1BlclNlY29uZC50b0ZpeGVkKDIpfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBBc3NlcnRpb25zIGZvciBlbmRwb2ludCBjb21wYXJpc29uXG4gICAgICBleHBlY3QocmVzdWx0cy5Mb2dpbi5hdmVyYWdlUmVzcG9uc2VUaW1lKS50b0JlTGVzc1RoYW4oMjAwMCk7XG4gICAgICBleHBlY3QocmVzdWx0cy5Qcm9maWxlLmF2ZXJhZ2VSZXNwb25zZVRpbWUpLnRvQmVMZXNzVGhhbigxMDAwKTtcbiAgICAgIGV4cGVjdChyZXN1bHRzLlJlZnJlc2guYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZUxlc3NUaGFuKDE1MDApO1xuICAgIH0sIDE4MDAwMCk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=