9c1522706b0aa22ad0e6f41e900d0747
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const departmentService_1 = require("../../src/services/hr/departmentService");
const testHelpers_1 = require("../utils/testHelpers");
const setup_1 = require("../setup");
// Create service instances
const departmentService = new departmentService_1.DepartmentService();
(0, globals_1.describe)('HR-Department Integration', () => {
    let testHelpers;
    let createdUserIds = [];
    let createdEmployeeIds = [];
    let createdDepartmentIds = [];
    (0, globals_1.beforeAll)(async () => {
        const { testDbPool } = await (0, setup_1.initializeTestConnections)();
        testHelpers = new testHelpers_1.TestHelpers(testDbPool);
    });
    (0, globals_1.afterEach)(async () => {
        // Clean up created data after each test
        for (const employeeId of createdEmployeeIds) {
            await testHelpers.deleteEmployee(employeeId).catch(() => { });
        }
        for (const userId of createdUserIds) {
            await testHelpers.deleteUser(userId).catch(() => { });
        }
        for (const departmentId of createdDepartmentIds) {
            await testHelpers.deleteDepartment(departmentId).catch(() => { });
        }
        createdEmployeeIds = [];
        createdUserIds = [];
        createdDepartmentIds = [];
    });
    (0, globals_1.describe)('Department Management Workflow', () => {
        (0, globals_1.it)('should handle complete department management workflow', async () => {
            // 1. Create department
            const department = await testHelpers.createTestDepartment({
                name: 'Engineering',
                description: 'Software Engineering Department'
            });
            createdDepartmentIds.push(department.id);
            // 2. Test department retrieval
            const departments = await departmentService.listDepartments();
            (0, globals_1.expect)(departments).toHaveProperty('departments');
            (0, globals_1.expect)(departments).toHaveProperty('total');
            (0, globals_1.expect)(Array.isArray(departments.departments)).toBe(true);
            (0, globals_1.expect)(typeof departments.total).toBe('number');
            // 3. Test specific department retrieval
            const specificDepartment = await departmentService.getDepartmentWithHead(department.id);
            (0, globals_1.expect)(specificDepartment).toHaveProperty('id');
            (0, globals_1.expect)(specificDepartment?.id).toBe(department.id);
            (0, globals_1.expect)(specificDepartment?.name).toBe('Engineering');
            // 4. Create department head user
            const departmentHead = await testHelpers.createTestUser({
                email: 'depthead@example.com',
                password: 'DeptHeadPassword123!',
                role: 'department_head'
            });
            createdUserIds.push(departmentHead.id);
            // 5. Create department head employee
            const departmentHeadEmployee = await testHelpers.createTestEmployee({
                userId: departmentHead.id,
                departmentId: department.id,
                employmentType: 'regular',
                baseSalary: 80000
            });
            createdEmployeeIds.push(departmentHeadEmployee.id);
            // 6. Test department operations
            const departmentStats = await departmentService.getDepartmentStats();
            (0, globals_1.expect)(departmentStats).toHaveProperty('total');
            (0, globals_1.expect)(departmentStats).toHaveProperty('active');
            (0, globals_1.expect)(typeof departmentStats.total).toBe('number');
        });
        (0, globals_1.it)('should handle department hierarchy management', async () => {
            // 1. Create parent department
            const parentDepartment = await testHelpers.createTestDepartment({
                name: 'Technology',
                description: 'Technology Division'
            });
            createdDepartmentIds.push(parentDepartment.id);
            // 2. Create child departments
            const childDepartments = [];
            for (let i = 0; i < 2; i++) {
                const childDept = await testHelpers.createTestDepartment({
                    name: `SubDepartment${i + 1}`,
                    description: `Sub Department ${i + 1} under Technology`
                });
                childDepartments.push(childDept);
                createdDepartmentIds.push(childDept.id);
            }
            // 3. Test department listing
            const allDepartments = await departmentService.listDepartments();
            (0, globals_1.expect)(allDepartments.departments.length).toBeGreaterThanOrEqual(3);
            // 4. Create employees in different departments
            const employees = [];
            for (let i = 0; i < 3; i++) {
                const user = await testHelpers.createTestUser({
                    email: `employee${i}@example.com`,
                    password: 'EmployeePassword123!',
                    role: 'employee'
                });
                createdUserIds.push(user.id);
                const employee = await testHelpers.createTestEmployee({
                    userId: user.id,
                    departmentId: i === 0 ? parentDepartment.id : childDepartments[i - 1].id,
                    employmentType: 'regular',
                    baseSalary: 50000 + (i * 10000)
                });
                employees.push(employee);
                createdEmployeeIds.push(employee.id);
            }
            // 5. Test department statistics with multiple departments
            const departmentStats = await departmentService.getDepartmentStats();
            (0, globals_1.expect)(departmentStats.total).toBeGreaterThanOrEqual(3);
        });
    });
    (0, globals_1.describe)('Department Operations Integration', () => {
        (0, globals_1.it)('should handle department operations correctly', async () => {
            // 1. Create department
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            // 2. Test department retrieval
            const departments = await departmentService.listDepartments();
            (0, globals_1.expect)(departments).toHaveProperty('departments');
            (0, globals_1.expect)(departments).toHaveProperty('total');
            (0, globals_1.expect)(Array.isArray(departments.departments)).toBe(true);
            // 3. Test specific department retrieval
            const specificDepartment = await departmentService.getDepartmentWithHead(department.id);
            (0, globals_1.expect)(specificDepartment).toHaveProperty('id');
            (0, globals_1.expect)(specificDepartment?.id).toBe(department.id);
        });
    });
    (0, globals_1.describe)('Service Integration Patterns', () => {
        (0, globals_1.it)('should handle concurrent department operations', async () => {
            // 1. Create test data
            const department = await testHelpers.createTestDepartment();
            createdDepartmentIds.push(department.id);
            // 2. Perform concurrent operations
            const promises = [
                departmentService.listDepartments(),
                departmentService.getDepartmentWithHead(department.id),
                departmentService.listDepartments()
            ];
            const results = await Promise.all(promises);
            // 3. Verify all operations completed successfully
            (0, globals_1.expect)(results).toHaveLength(3);
            results.forEach((result) => {
                (0, globals_1.expect)(result).toBeDefined();
            });
            // 4. Verify specific result types
            (0, globals_1.expect)(results[0]).toHaveProperty('departments');
            (0, globals_1.expect)(results[1]).toHaveProperty('id');
            (0, globals_1.expect)(results[2]).toHaveProperty('departments');
        });
        (0, globals_1.it)('should handle error scenarios gracefully', async () => {
            // Test with non-existent department
            const nonExistentDept = await departmentService.getDepartmentWithHead('non-existent-id');
            (0, globals_1.expect)(nonExistentDept).toBeNull();
            // Test department stats with no data
            const departmentStats = await departmentService.getDepartmentStats();
            (0, globals_1.expect)(departmentStats).toHaveProperty('total');
            (0, globals_1.expect)(departmentStats).toHaveProperty('active');
            (0, globals_1.expect)(typeof departmentStats.total).toBe('number');
        });
        (0, globals_1.it)('should maintain data consistency', async () => {
            // 1. Create department
            const department = await testHelpers.createTestDepartment({
                name: 'Consistency Test Department'
            });
            createdDepartmentIds.push(department.id);
            // 2. Verify data consistency
            const departmentData = await departmentService.getDepartmentWithHead(department.id);
            (0, globals_1.expect)(departmentData?.id).toBe(department.id);
            (0, globals_1.expect)(departmentData?.name).toBe('Consistency Test Department');
            // 3. Verify statistics consistency
            const departmentStats = await departmentService.getDepartmentStats();
            (0, globals_1.expect)(departmentStats.total).toBeGreaterThanOrEqual(1);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva2ltL3RpdG8vc2VydmVyL3Rlc3RzL2ludGVncmF0aW9uL2hyRGVwYXJ0bWVudEludGVncmF0aW9uLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBMkU7QUFDM0UsK0VBQTRFO0FBQzVFLHNEQUFtRDtBQUNuRCxvQ0FBcUQ7QUFFckQsMkJBQTJCO0FBQzNCLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxxQ0FBaUIsRUFBRSxDQUFDO0FBRWxELElBQUEsa0JBQVEsRUFBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7SUFDekMsSUFBSSxXQUF3QixDQUFDO0lBQzdCLElBQUksY0FBYyxHQUFhLEVBQUUsQ0FBQztJQUNsQyxJQUFJLGtCQUFrQixHQUFhLEVBQUUsQ0FBQztJQUN0QyxJQUFJLG9CQUFvQixHQUFhLEVBQUUsQ0FBQztJQUV4QyxJQUFBLG1CQUFTLEVBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLE1BQU0sSUFBQSxpQ0FBeUIsR0FBRSxDQUFDO1FBQ3pELFdBQVcsR0FBRyxJQUFJLHlCQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLG1CQUFTLEVBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsd0NBQXdDO1FBQ3hDLEtBQUssTUFBTSxVQUFVLElBQUksa0JBQWtCLEVBQUUsQ0FBQztZQUM1QyxNQUFNLFdBQVcsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFDRCxLQUFLLE1BQU0sTUFBTSxJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ3BDLE1BQU0sV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdkQsQ0FBQztRQUNELEtBQUssTUFBTSxZQUFZLElBQUksb0JBQW9CLEVBQUUsQ0FBQztZQUNoRCxNQUFNLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUNELGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUN4QixjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztJQUM1QixDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsa0JBQVEsRUFBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7UUFDOUMsSUFBQSxZQUFFLEVBQUMsdURBQXVELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDckUsdUJBQXVCO1lBQ3ZCLE1BQU0sVUFBVSxHQUFHLE1BQU0sV0FBVyxDQUFDLG9CQUFvQixDQUFDO2dCQUN4RCxJQUFJLEVBQUUsYUFBYTtnQkFDbkIsV0FBVyxFQUFFLGlDQUFpQzthQUMvQyxDQUFDLENBQUM7WUFDSCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXpDLCtCQUErQjtZQUMvQixNQUFNLFdBQVcsR0FBRyxNQUFNLGlCQUFpQixDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQzlELElBQUEsZ0JBQU0sRUFBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDbEQsSUFBQSxnQkFBTSxFQUFDLFdBQVcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM1QyxJQUFBLGdCQUFNLEVBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUQsSUFBQSxnQkFBTSxFQUFDLE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVoRCx3Q0FBd0M7WUFDeEMsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN4RixJQUFBLGdCQUFNLEVBQUMsa0JBQWtCLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEQsSUFBQSxnQkFBTSxFQUFDLGtCQUFrQixFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbkQsSUFBQSxnQkFBTSxFQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUVyRCxpQ0FBaUM7WUFDakMsTUFBTSxjQUFjLEdBQUcsTUFBTSxXQUFXLENBQUMsY0FBYyxDQUFDO2dCQUN0RCxLQUFLLEVBQUUsc0JBQXNCO2dCQUM3QixRQUFRLEVBQUUsc0JBQXNCO2dCQUNoQyxJQUFJLEVBQUUsaUJBQWlCO2FBQ3hCLENBQUMsQ0FBQztZQUNILGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXZDLHFDQUFxQztZQUNyQyxNQUFNLHNCQUFzQixHQUFHLE1BQU0sV0FBVyxDQUFDLGtCQUFrQixDQUFDO2dCQUNsRSxNQUFNLEVBQUUsY0FBYyxDQUFDLEVBQUU7Z0JBQ3pCLFlBQVksRUFBRSxVQUFVLENBQUMsRUFBRTtnQkFDM0IsY0FBYyxFQUFFLFNBQVM7Z0JBQ3pCLFVBQVUsRUFBRSxLQUFLO2FBQ2xCLENBQUMsQ0FBQztZQUNILGtCQUFrQixDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUVuRCxnQ0FBZ0M7WUFDaEMsTUFBTSxlQUFlLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQ3JFLElBQUEsZ0JBQU0sRUFBQyxlQUFlLENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEQsSUFBQSxnQkFBTSxFQUFDLGVBQWUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNqRCxJQUFBLGdCQUFNLEVBQUMsT0FBTyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBQSxZQUFFLEVBQUMsK0NBQStDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDN0QsOEJBQThCO1lBQzlCLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxXQUFXLENBQUMsb0JBQW9CLENBQUM7Z0JBQzlELElBQUksRUFBRSxZQUFZO2dCQUNsQixXQUFXLEVBQUUscUJBQXFCO2FBQ25DLENBQUMsQ0FBQztZQUNILG9CQUFvQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUUvQyw4QkFBOEI7WUFDOUIsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7WUFDNUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUMzQixNQUFNLFNBQVMsR0FBRyxNQUFNLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQztvQkFDdkQsSUFBSSxFQUFFLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUM3QixXQUFXLEVBQUUsa0JBQWtCLENBQUMsR0FBRyxDQUFDLG1CQUFtQjtpQkFDeEQsQ0FBQyxDQUFDO2dCQUNILGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDakMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMxQyxDQUFDO1lBRUQsNkJBQTZCO1lBQzdCLE1BQU0sY0FBYyxHQUFHLE1BQU0saUJBQWlCLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDakUsSUFBQSxnQkFBTSxFQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFcEUsK0NBQStDO1lBQy9DLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUNyQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQzNCLE1BQU0sSUFBSSxHQUFHLE1BQU0sV0FBVyxDQUFDLGNBQWMsQ0FBQztvQkFDNUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxjQUFjO29CQUNqQyxRQUFRLEVBQUUsc0JBQXNCO29CQUNoQyxJQUFJLEVBQUUsVUFBVTtpQkFDakIsQ0FBQyxDQUFDO2dCQUNILGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUU3QixNQUFNLFFBQVEsR0FBRyxNQUFNLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQztvQkFDcEQsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO29CQUNmLFlBQVksRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUN4RSxjQUFjLEVBQUUsU0FBUztvQkFDekIsVUFBVSxFQUFFLEtBQUssR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7aUJBQ2hDLENBQUMsQ0FBQztnQkFDSCxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN6QixrQkFBa0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLENBQUM7WUFFRCwwREFBMEQ7WUFDMUQsTUFBTSxlQUFlLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQ3JFLElBQUEsZ0JBQU0sRUFBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsa0JBQVEsRUFBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7UUFDakQsSUFBQSxZQUFFLEVBQUMsK0NBQStDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDN0QsdUJBQXVCO1lBQ3ZCLE1BQU0sVUFBVSxHQUFHLE1BQU0sV0FBVyxDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDNUQsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUV6QywrQkFBK0I7WUFDL0IsTUFBTSxXQUFXLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUM5RCxJQUFBLGdCQUFNLEVBQUMsV0FBVyxDQUFDLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ2xELElBQUEsZ0JBQU0sRUFBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDNUMsSUFBQSxnQkFBTSxFQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTFELHdDQUF3QztZQUN4QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0saUJBQWlCLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3hGLElBQUEsZ0JBQU0sRUFBQyxrQkFBa0IsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoRCxJQUFBLGdCQUFNLEVBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxrQkFBUSxFQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtRQUM1QyxJQUFBLFlBQUUsRUFBQyxnREFBZ0QsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM5RCxzQkFBc0I7WUFDdEIsTUFBTSxVQUFVLEdBQUcsTUFBTSxXQUFXLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUM1RCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXpDLG1DQUFtQztZQUNuQyxNQUFNLFFBQVEsR0FBRztnQkFDZixpQkFBaUIsQ0FBQyxlQUFlLEVBQUU7Z0JBQ25DLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7Z0JBQ3RELGlCQUFpQixDQUFDLGVBQWUsRUFBRTthQUNwQyxDQUFDO1lBRUYsTUFBTSxPQUFPLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTVDLGtEQUFrRDtZQUNsRCxJQUFBLGdCQUFNLEVBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRTtnQkFDOUIsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQy9CLENBQUMsQ0FBQyxDQUFDO1lBRUgsa0NBQWtDO1lBQ2xDLElBQUEsZ0JBQU0sRUFBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDakQsSUFBQSxnQkFBTSxFQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QyxJQUFBLGdCQUFNLEVBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBQSxZQUFFLEVBQUMsMENBQTBDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDeEQsb0NBQW9DO1lBQ3BDLE1BQU0sZUFBZSxHQUFHLE1BQU0saUJBQWlCLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUN6RixJQUFBLGdCQUFNLEVBQUMsZUFBZSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7WUFFbkMscUNBQXFDO1lBQ3JDLE1BQU0sZUFBZSxHQUFHLE1BQU0saUJBQWlCLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUNyRSxJQUFBLGdCQUFNLEVBQUMsZUFBZSxDQUFDLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELElBQUEsZ0JBQU0sRUFBQyxlQUFlLENBQUMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakQsSUFBQSxnQkFBTSxFQUFDLE9BQU8sZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUEsWUFBRSxFQUFDLGtDQUFrQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2hELHVCQUF1QjtZQUN2QixNQUFNLFVBQVUsR0FBRyxNQUFNLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDeEQsSUFBSSxFQUFFLDZCQUE2QjthQUNwQyxDQUFDLENBQUM7WUFDSCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXpDLDZCQUE2QjtZQUM3QixNQUFNLGNBQWMsR0FBRyxNQUFNLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNwRixJQUFBLGdCQUFNLEVBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDL0MsSUFBQSxnQkFBTSxFQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsQ0FBQztZQUVqRSxtQ0FBbUM7WUFDbkMsTUFBTSxlQUFlLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQ3JFLElBQUEsZ0JBQU0sRUFBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2tpbS90aXRvL3NlcnZlci90ZXN0cy9pbnRlZ3JhdGlvbi9ockRlcGFydG1lbnRJbnRlZ3JhdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVBbGwsIGFmdGVyRWFjaCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHsgRGVwYXJ0bWVudFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvaHIvZGVwYXJ0bWVudFNlcnZpY2UnO1xuaW1wb3J0IHsgVGVzdEhlbHBlcnMgfSBmcm9tICcuLi91dGlscy90ZXN0SGVscGVycyc7XG5pbXBvcnQgeyBpbml0aWFsaXplVGVzdENvbm5lY3Rpb25zIH0gZnJvbSAnLi4vc2V0dXAnO1xuXG4vLyBDcmVhdGUgc2VydmljZSBpbnN0YW5jZXNcbmNvbnN0IGRlcGFydG1lbnRTZXJ2aWNlID0gbmV3IERlcGFydG1lbnRTZXJ2aWNlKCk7XG5cbmRlc2NyaWJlKCdIUi1EZXBhcnRtZW50IEludGVncmF0aW9uJywgKCkgPT4ge1xuICBsZXQgdGVzdEhlbHBlcnM6IFRlc3RIZWxwZXJzO1xuICBsZXQgY3JlYXRlZFVzZXJJZHM6IHN0cmluZ1tdID0gW107XG4gIGxldCBjcmVhdGVkRW1wbG95ZWVJZHM6IHN0cmluZ1tdID0gW107XG4gIGxldCBjcmVhdGVkRGVwYXJ0bWVudElkczogc3RyaW5nW10gPSBbXTtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgdGVzdERiUG9vbCB9ID0gYXdhaXQgaW5pdGlhbGl6ZVRlc3RDb25uZWN0aW9ucygpO1xuICAgIHRlc3RIZWxwZXJzID0gbmV3IFRlc3RIZWxwZXJzKHRlc3REYlBvb2wpO1xuICB9KTtcblxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIENsZWFuIHVwIGNyZWF0ZWQgZGF0YSBhZnRlciBlYWNoIHRlc3RcbiAgICBmb3IgKGNvbnN0IGVtcGxveWVlSWQgb2YgY3JlYXRlZEVtcGxveWVlSWRzKSB7IFxuICAgICAgYXdhaXQgdGVzdEhlbHBlcnMuZGVsZXRlRW1wbG95ZWUoZW1wbG95ZWVJZCkuY2F0Y2goKCkgPT4ge30pOyBcbiAgICB9XG4gICAgZm9yIChjb25zdCB1c2VySWQgb2YgY3JlYXRlZFVzZXJJZHMpIHsgXG4gICAgICBhd2FpdCB0ZXN0SGVscGVycy5kZWxldGVVc2VyKHVzZXJJZCkuY2F0Y2goKCkgPT4ge30pOyBcbiAgICB9XG4gICAgZm9yIChjb25zdCBkZXBhcnRtZW50SWQgb2YgY3JlYXRlZERlcGFydG1lbnRJZHMpIHsgXG4gICAgICBhd2FpdCB0ZXN0SGVscGVycy5kZWxldGVEZXBhcnRtZW50KGRlcGFydG1lbnRJZCkuY2F0Y2goKCkgPT4ge30pOyBcbiAgICB9XG4gICAgY3JlYXRlZEVtcGxveWVlSWRzID0gW107XG4gICAgY3JlYXRlZFVzZXJJZHMgPSBbXTtcbiAgICBjcmVhdGVkRGVwYXJ0bWVudElkcyA9IFtdO1xuICB9KTtcblxuICBkZXNjcmliZSgnRGVwYXJ0bWVudCBNYW5hZ2VtZW50IFdvcmtmbG93JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGNvbXBsZXRlIGRlcGFydG1lbnQgbWFuYWdlbWVudCB3b3JrZmxvdycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIDEuIENyZWF0ZSBkZXBhcnRtZW50XG4gICAgICBjb25zdCBkZXBhcnRtZW50ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoe1xuICAgICAgICBuYW1lOiAnRW5naW5lZXJpbmcnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1NvZnR3YXJlIEVuZ2luZWVyaW5nIERlcGFydG1lbnQnXG4gICAgICB9KTtcbiAgICAgIGNyZWF0ZWREZXBhcnRtZW50SWRzLnB1c2goZGVwYXJ0bWVudC5pZCk7XG5cbiAgICAgIC8vIDIuIFRlc3QgZGVwYXJ0bWVudCByZXRyaWV2YWxcbiAgICAgIGNvbnN0IGRlcGFydG1lbnRzID0gYXdhaXQgZGVwYXJ0bWVudFNlcnZpY2UubGlzdERlcGFydG1lbnRzKCk7XG4gICAgICBleHBlY3QoZGVwYXJ0bWVudHMpLnRvSGF2ZVByb3BlcnR5KCdkZXBhcnRtZW50cycpO1xuICAgICAgZXhwZWN0KGRlcGFydG1lbnRzKS50b0hhdmVQcm9wZXJ0eSgndG90YWwnKTtcbiAgICAgIGV4cGVjdChBcnJheS5pc0FycmF5KGRlcGFydG1lbnRzLmRlcGFydG1lbnRzKSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgZGVwYXJ0bWVudHMudG90YWwpLnRvQmUoJ251bWJlcicpO1xuXG4gICAgICAvLyAzLiBUZXN0IHNwZWNpZmljIGRlcGFydG1lbnQgcmV0cmlldmFsXG4gICAgICBjb25zdCBzcGVjaWZpY0RlcGFydG1lbnQgPSBhd2FpdCBkZXBhcnRtZW50U2VydmljZS5nZXREZXBhcnRtZW50V2l0aEhlYWQoZGVwYXJ0bWVudC5pZCk7XG4gICAgICBleHBlY3Qoc3BlY2lmaWNEZXBhcnRtZW50KS50b0hhdmVQcm9wZXJ0eSgnaWQnKTtcbiAgICAgIGV4cGVjdChzcGVjaWZpY0RlcGFydG1lbnQ/LmlkKS50b0JlKGRlcGFydG1lbnQuaWQpO1xuICAgICAgZXhwZWN0KHNwZWNpZmljRGVwYXJ0bWVudD8ubmFtZSkudG9CZSgnRW5naW5lZXJpbmcnKTtcblxuICAgICAgLy8gNC4gQ3JlYXRlIGRlcGFydG1lbnQgaGVhZCB1c2VyXG4gICAgICBjb25zdCBkZXBhcnRtZW50SGVhZCA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3RVc2VyKHtcbiAgICAgICAgZW1haWw6ICdkZXB0aGVhZEBleGFtcGxlLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAnRGVwdEhlYWRQYXNzd29yZDEyMyEnLFxuICAgICAgICByb2xlOiAnZGVwYXJ0bWVudF9oZWFkJ1xuICAgICAgfSk7XG4gICAgICBjcmVhdGVkVXNlcklkcy5wdXNoKGRlcGFydG1lbnRIZWFkLmlkKTtcblxuICAgICAgLy8gNS4gQ3JlYXRlIGRlcGFydG1lbnQgaGVhZCBlbXBsb3llZVxuICAgICAgY29uc3QgZGVwYXJ0bWVudEhlYWRFbXBsb3llZSA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3RFbXBsb3llZSh7XG4gICAgICAgIHVzZXJJZDogZGVwYXJ0bWVudEhlYWQuaWQsXG4gICAgICAgIGRlcGFydG1lbnRJZDogZGVwYXJ0bWVudC5pZCxcbiAgICAgICAgZW1wbG95bWVudFR5cGU6ICdyZWd1bGFyJyxcbiAgICAgICAgYmFzZVNhbGFyeTogODAwMDBcbiAgICAgIH0pO1xuICAgICAgY3JlYXRlZEVtcGxveWVlSWRzLnB1c2goZGVwYXJ0bWVudEhlYWRFbXBsb3llZS5pZCk7XG5cbiAgICAgIC8vIDYuIFRlc3QgZGVwYXJ0bWVudCBvcGVyYXRpb25zXG4gICAgICBjb25zdCBkZXBhcnRtZW50U3RhdHMgPSBhd2FpdCBkZXBhcnRtZW50U2VydmljZS5nZXREZXBhcnRtZW50U3RhdHMoKTtcbiAgICAgIGV4cGVjdChkZXBhcnRtZW50U3RhdHMpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbCcpO1xuICAgICAgZXhwZWN0KGRlcGFydG1lbnRTdGF0cykudG9IYXZlUHJvcGVydHkoJ2FjdGl2ZScpO1xuICAgICAgZXhwZWN0KHR5cGVvZiBkZXBhcnRtZW50U3RhdHMudG90YWwpLnRvQmUoJ251bWJlcicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZGVwYXJ0bWVudCBoaWVyYXJjaHkgbWFuYWdlbWVudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIDEuIENyZWF0ZSBwYXJlbnQgZGVwYXJ0bWVudFxuICAgICAgY29uc3QgcGFyZW50RGVwYXJ0bWVudCA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3REZXBhcnRtZW50KHtcbiAgICAgICAgbmFtZTogJ1RlY2hub2xvZ3knLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RlY2hub2xvZ3kgRGl2aXNpb24nXG4gICAgICB9KTtcbiAgICAgIGNyZWF0ZWREZXBhcnRtZW50SWRzLnB1c2gocGFyZW50RGVwYXJ0bWVudC5pZCk7XG5cbiAgICAgIC8vIDIuIENyZWF0ZSBjaGlsZCBkZXBhcnRtZW50c1xuICAgICAgY29uc3QgY2hpbGREZXBhcnRtZW50cyA9IFtdO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyBpKyspIHtcbiAgICAgICAgY29uc3QgY2hpbGREZXB0ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoe1xuICAgICAgICAgIG5hbWU6IGBTdWJEZXBhcnRtZW50JHtpICsgMX1gLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgU3ViIERlcGFydG1lbnQgJHtpICsgMX0gdW5kZXIgVGVjaG5vbG9neWBcbiAgICAgICAgfSk7XG4gICAgICAgIGNoaWxkRGVwYXJ0bWVudHMucHVzaChjaGlsZERlcHQpO1xuICAgICAgICBjcmVhdGVkRGVwYXJ0bWVudElkcy5wdXNoKGNoaWxkRGVwdC5pZCk7XG4gICAgICB9XG5cbiAgICAgIC8vIDMuIFRlc3QgZGVwYXJ0bWVudCBsaXN0aW5nXG4gICAgICBjb25zdCBhbGxEZXBhcnRtZW50cyA9IGF3YWl0IGRlcGFydG1lbnRTZXJ2aWNlLmxpc3REZXBhcnRtZW50cygpO1xuICAgICAgZXhwZWN0KGFsbERlcGFydG1lbnRzLmRlcGFydG1lbnRzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgzKTtcblxuICAgICAgLy8gNC4gQ3JlYXRlIGVtcGxveWVlcyBpbiBkaWZmZXJlbnQgZGVwYXJ0bWVudHNcbiAgICAgIGNvbnN0IGVtcGxveWVlcyA9IFtdO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHtcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3RVc2VyKHtcbiAgICAgICAgICBlbWFpbDogYGVtcGxveWVlJHtpfUBleGFtcGxlLmNvbWAsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdFbXBsb3llZVBhc3N3b3JkMTIzIScsXG4gICAgICAgICAgcm9sZTogJ2VtcGxveWVlJ1xuICAgICAgICB9KTtcbiAgICAgICAgY3JlYXRlZFVzZXJJZHMucHVzaCh1c2VyLmlkKTtcblxuICAgICAgICBjb25zdCBlbXBsb3llZSA9IGF3YWl0IHRlc3RIZWxwZXJzLmNyZWF0ZVRlc3RFbXBsb3llZSh7XG4gICAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICAgIGRlcGFydG1lbnRJZDogaSA9PT0gMCA/IHBhcmVudERlcGFydG1lbnQuaWQgOiBjaGlsZERlcGFydG1lbnRzW2kgLSAxXS5pZCxcbiAgICAgICAgICBlbXBsb3ltZW50VHlwZTogJ3JlZ3VsYXInLFxuICAgICAgICAgIGJhc2VTYWxhcnk6IDUwMDAwICsgKGkgKiAxMDAwMClcbiAgICAgICAgfSk7XG4gICAgICAgIGVtcGxveWVlcy5wdXNoKGVtcGxveWVlKTtcbiAgICAgICAgY3JlYXRlZEVtcGxveWVlSWRzLnB1c2goZW1wbG95ZWUuaWQpO1xuICAgICAgfVxuXG4gICAgICAvLyA1LiBUZXN0IGRlcGFydG1lbnQgc3RhdGlzdGljcyB3aXRoIG11bHRpcGxlIGRlcGFydG1lbnRzXG4gICAgICBjb25zdCBkZXBhcnRtZW50U3RhdHMgPSBhd2FpdCBkZXBhcnRtZW50U2VydmljZS5nZXREZXBhcnRtZW50U3RhdHMoKTtcbiAgICAgIGV4cGVjdChkZXBhcnRtZW50U3RhdHMudG90YWwpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdEZXBhcnRtZW50IE9wZXJhdGlvbnMgSW50ZWdyYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZGVwYXJ0bWVudCBvcGVyYXRpb25zIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIDEuIENyZWF0ZSBkZXBhcnRtZW50XG4gICAgICBjb25zdCBkZXBhcnRtZW50ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoKTtcbiAgICAgIGNyZWF0ZWREZXBhcnRtZW50SWRzLnB1c2goZGVwYXJ0bWVudC5pZCk7XG5cbiAgICAgIC8vIDIuIFRlc3QgZGVwYXJ0bWVudCByZXRyaWV2YWxcbiAgICAgIGNvbnN0IGRlcGFydG1lbnRzID0gYXdhaXQgZGVwYXJ0bWVudFNlcnZpY2UubGlzdERlcGFydG1lbnRzKCk7XG4gICAgICBleHBlY3QoZGVwYXJ0bWVudHMpLnRvSGF2ZVByb3BlcnR5KCdkZXBhcnRtZW50cycpO1xuICAgICAgZXhwZWN0KGRlcGFydG1lbnRzKS50b0hhdmVQcm9wZXJ0eSgndG90YWwnKTtcbiAgICAgIGV4cGVjdChBcnJheS5pc0FycmF5KGRlcGFydG1lbnRzLmRlcGFydG1lbnRzKSkudG9CZSh0cnVlKTtcblxuICAgICAgLy8gMy4gVGVzdCBzcGVjaWZpYyBkZXBhcnRtZW50IHJldHJpZXZhbFxuICAgICAgY29uc3Qgc3BlY2lmaWNEZXBhcnRtZW50ID0gYXdhaXQgZGVwYXJ0bWVudFNlcnZpY2UuZ2V0RGVwYXJ0bWVudFdpdGhIZWFkKGRlcGFydG1lbnQuaWQpO1xuICAgICAgZXhwZWN0KHNwZWNpZmljRGVwYXJ0bWVudCkudG9IYXZlUHJvcGVydHkoJ2lkJyk7XG4gICAgICBleHBlY3Qoc3BlY2lmaWNEZXBhcnRtZW50Py5pZCkudG9CZShkZXBhcnRtZW50LmlkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1NlcnZpY2UgSW50ZWdyYXRpb24gUGF0dGVybnMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgY29uY3VycmVudCBkZXBhcnRtZW50IG9wZXJhdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyAxLiBDcmVhdGUgdGVzdCBkYXRhXG4gICAgICBjb25zdCBkZXBhcnRtZW50ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoKTtcbiAgICAgIGNyZWF0ZWREZXBhcnRtZW50SWRzLnB1c2goZGVwYXJ0bWVudC5pZCk7XG5cbiAgICAgIC8vIDIuIFBlcmZvcm0gY29uY3VycmVudCBvcGVyYXRpb25zXG4gICAgICBjb25zdCBwcm9taXNlcyA9IFtcbiAgICAgICAgZGVwYXJ0bWVudFNlcnZpY2UubGlzdERlcGFydG1lbnRzKCksXG4gICAgICAgIGRlcGFydG1lbnRTZXJ2aWNlLmdldERlcGFydG1lbnRXaXRoSGVhZChkZXBhcnRtZW50LmlkKSxcbiAgICAgICAgZGVwYXJ0bWVudFNlcnZpY2UubGlzdERlcGFydG1lbnRzKClcbiAgICAgIF07XG5cbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XG5cbiAgICAgIC8vIDMuIFZlcmlmeSBhbGwgb3BlcmF0aW9ucyBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5XG4gICAgICBleHBlY3QocmVzdWx0cykudG9IYXZlTGVuZ3RoKDMpO1xuICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIDQuIFZlcmlmeSBzcGVjaWZpYyByZXN1bHQgdHlwZXNcbiAgICAgIGV4cGVjdChyZXN1bHRzWzBdKS50b0hhdmVQcm9wZXJ0eSgnZGVwYXJ0bWVudHMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHRzWzFdKS50b0hhdmVQcm9wZXJ0eSgnaWQnKTtcbiAgICAgIGV4cGVjdChyZXN1bHRzWzJdKS50b0hhdmVQcm9wZXJ0eSgnZGVwYXJ0bWVudHMnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVycm9yIHNjZW5hcmlvcyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVGVzdCB3aXRoIG5vbi1leGlzdGVudCBkZXBhcnRtZW50XG4gICAgICBjb25zdCBub25FeGlzdGVudERlcHQgPSBhd2FpdCBkZXBhcnRtZW50U2VydmljZS5nZXREZXBhcnRtZW50V2l0aEhlYWQoJ25vbi1leGlzdGVudC1pZCcpO1xuICAgICAgZXhwZWN0KG5vbkV4aXN0ZW50RGVwdCkudG9CZU51bGwoKTtcblxuICAgICAgLy8gVGVzdCBkZXBhcnRtZW50IHN0YXRzIHdpdGggbm8gZGF0YVxuICAgICAgY29uc3QgZGVwYXJ0bWVudFN0YXRzID0gYXdhaXQgZGVwYXJ0bWVudFNlcnZpY2UuZ2V0RGVwYXJ0bWVudFN0YXRzKCk7XG4gICAgICBleHBlY3QoZGVwYXJ0bWVudFN0YXRzKS50b0hhdmVQcm9wZXJ0eSgndG90YWwnKTtcbiAgICAgIGV4cGVjdChkZXBhcnRtZW50U3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdhY3RpdmUnKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgZGVwYXJ0bWVudFN0YXRzLnRvdGFsKS50b0JlKCdudW1iZXInKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbWFpbnRhaW4gZGF0YSBjb25zaXN0ZW5jeScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIDEuIENyZWF0ZSBkZXBhcnRtZW50XG4gICAgICBjb25zdCBkZXBhcnRtZW50ID0gYXdhaXQgdGVzdEhlbHBlcnMuY3JlYXRlVGVzdERlcGFydG1lbnQoe1xuICAgICAgICBuYW1lOiAnQ29uc2lzdGVuY3kgVGVzdCBEZXBhcnRtZW50J1xuICAgICAgfSk7XG4gICAgICBjcmVhdGVkRGVwYXJ0bWVudElkcy5wdXNoKGRlcGFydG1lbnQuaWQpO1xuXG4gICAgICAvLyAyLiBWZXJpZnkgZGF0YSBjb25zaXN0ZW5jeVxuICAgICAgY29uc3QgZGVwYXJ0bWVudERhdGEgPSBhd2FpdCBkZXBhcnRtZW50U2VydmljZS5nZXREZXBhcnRtZW50V2l0aEhlYWQoZGVwYXJ0bWVudC5pZCk7XG4gICAgICBleHBlY3QoZGVwYXJ0bWVudERhdGE/LmlkKS50b0JlKGRlcGFydG1lbnQuaWQpO1xuICAgICAgZXhwZWN0KGRlcGFydG1lbnREYXRhPy5uYW1lKS50b0JlKCdDb25zaXN0ZW5jeSBUZXN0IERlcGFydG1lbnQnKTtcblxuICAgICAgLy8gMy4gVmVyaWZ5IHN0YXRpc3RpY3MgY29uc2lzdGVuY3lcbiAgICAgIGNvbnN0IGRlcGFydG1lbnRTdGF0cyA9IGF3YWl0IGRlcGFydG1lbnRTZXJ2aWNlLmdldERlcGFydG1lbnRTdGF0cygpO1xuICAgICAgZXhwZWN0KGRlcGFydG1lbnRTdGF0cy50b3RhbCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgxKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==