{"version":3,"names":["cov_168kd5w9","actualCoverage","express_1","s","require","kioskController_1","__importDefault","multer_1","kioskAuth_1","validate_1","kioskSchemas_1","rateLimitMiddleware_1","helmet_1","router","Router","kioskRateLimit","createRedisRateLimit","windowMs","maxRequests","message","keyGenerator","req","f","ip","b","get","use","default","contentSecurityPolicy","directives","defaultSrc","styleSrc","scriptSrc","imgSrc","connectSrc","fontSrc","objectSrc","mediaSrc","frameSrc","crossOriginEmbedderPolicy","crossOriginResourcePolicy","policy","hsts","maxAge","includeSubDomains","preload","kioskAuth","verifyEmployeeByQR","post","validateBody","kioskAttendanceSchema","recordAttendance","validateParams","kioskParamsSchema","getLastAttendance","getAttendanceHistory","getNextExpectedSession","getTodayAttendanceSummary","uploadSelfie","handleMulterError","recordTimeBasedAttendance","kioskValidateSchema","validateAttendanceAction","exports"],"sources":["/home/kim/tito/server/src/routes/kiosk/kioskRoutes.ts"],"sourcesContent":["import { Router } from 'express';\nimport kioskController from '../../controllers/kiosk/kioskController';\nimport { uploadSelfie, handleMulterError } from '../../config/multer';\nimport { kioskAuth } from '../../middleware/auth/kioskAuth';\nimport { validateBody, validateParams } from '../../middleware/validation/validate';\nimport { kioskAttendanceSchema, kioskValidateSchema, kioskParamsSchema } from '../../middleware/validation/schemas/kioskSchemas';\nimport { createRedisRateLimit } from '../../middleware/redis/rateLimitMiddleware';\nimport helmet from 'helmet';\n\nconst router = Router();\n\n// SECURITY: Apply stricter rate limiting for kiosk endpoints to prevent abuse\nconst kioskRateLimit = createRedisRateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  maxRequests: 50, // 50 requests per 15 minutes per IP\n  message: 'Too many kiosk requests, please try again later',\n  keyGenerator: (req) => {\n    // Use IP + User-Agent for rate limiting to prevent simple IP spoofing\n    return `${req.ip}-${req.get('User-Agent') || 'unknown'}`;\n  }\n});\n\n// SECURITY: Apply additional security headers for kiosk endpoints\nrouter.use(helmet({\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\"], // For potential styling needs\n      scriptSrc: [\"'self'\"],\n      imgSrc: [\"'self'\", \"data:\", \"blob:\"], // Allow data URLs and blobs for QR codes\n      connectSrc: [\"'self'\"],\n      fontSrc: [\"'self'\"],\n      objectSrc: [\"'none'\"],\n      mediaSrc: [\"'self'\"],\n      frameSrc: [\"'none'\"],\n    },\n  },\n  crossOriginEmbedderPolicy: false,\n  crossOriginResourcePolicy: { policy: \"cross-origin\" },\n  hsts: {\n    maxAge: 31536000,\n    includeSubDomains: true,\n    preload: true\n  }\n}));\n\n// Apply rate limiting and authentication to all kiosk routes\nrouter.use(kioskRateLimit);\nrouter.use(kioskAuth);\n\n// Kiosk routes with proper authentication and validation\nrouter.get('/verify-qr', kioskController.verifyEmployeeByQR);\nrouter.post('/attendance', validateBody(kioskAttendanceSchema), kioskController.recordAttendance);\nrouter.get('/attendance/last/:employeeId', validateParams(kioskParamsSchema), kioskController.getLastAttendance);\nrouter.get('/attendance/history/:employeeId', validateParams(kioskParamsSchema), kioskController.getAttendanceHistory);\n\n// Time-based attendance routes\nrouter.get('/attendance/next-session/:employeeId', validateParams(kioskParamsSchema), kioskController.getNextExpectedSession);\nrouter.get('/attendance/today-summary/:employeeId', validateParams(kioskParamsSchema), kioskController.getTodayAttendanceSummary);\nrouter.post('/attendance/time-based', uploadSelfie, handleMulterError, kioskController.recordTimeBasedAttendance);\nrouter.post('/attendance/validate', validateBody(kioskValidateSchema), kioskController.validateAttendanceAction);\n\nexport default router;\n"],"mappings":"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","ignoreList":[]}